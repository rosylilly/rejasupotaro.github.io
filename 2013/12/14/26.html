<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" />
    <title>AndroidのCIに纏わる諸々の問題 - Rejasupoem</title><link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" /><link href="/stylesheets/all.css?1392182354" media="all" rel="stylesheet" type="text/css" /><link href="/images/favicon.ico" rel="icon" type="image/ico" />
  </head>
  <body>
    <link href="http://yandex.st/highlightjs/8.0/styles/monokai_sublime.min.css" rel="stylesheet" type="text/css" />
    <script src="http://yandex.st/highlightjs/8.0/highlight.min.js"></script>
    <script type="text/javascript">
      hljs.initHighlightingOnLoad();
    </script>
    <header class="header">
      <div class="header-inner"><a href="/">
        <div class="header-image">
          <img width="100" height="100" class="header-image-element" src="/images/rejasupotaro.jpg?1392182354" />
        </div>
        <div class="header-text">
          <h1 class="header-text-title">
            Rejasupoem
          </h1>
          <p class="header-text-description">
            deliver value to customers continuously or die;
          </p>
        </div></a>
        
      </div>
    </header>
    <hr />
    <div class="main">
      <div class="main-inner main-inner-single-article"><article class="main-article">
  <div class="main-article-header">
    <h1 class="main-article-header-title">
      AndroidのCIに纏わる諸々の問題
    </h1>
    <div class="main-article-header-date">
      2013-12-14
    </div>
  </div><p>この投稿は<a href="http://qiita.com/advent-calendar/2013/android">Android Advent Calendar 2013</a>の14日目の記事です。</p>

<p>昨日、<a href="http://www.zusaar.com/event/1917003">Android Test Casual Talks #1</a>というイベントがありました。
僕もテストについて<a href="http://rejasupotaro.github.io/blog/2013/12/14/25/">何か話す</a>予定だったのですが、残念ながら体調不良のため行けませんでした。
それで、ハッシュタグを追って見ていたのですが、現場に入ったときにAndroidにテストを書く文化がなくて驚いたという話がありましたが、今やその状況もだいぶ変わってきていて、会場にいた人の80%の人がJenkinsを導入しているというのはちょっとすごいなと思いました。</p>

<p>さて、そんなJenkinsですが、弊社では運用についていくつかの悩みを抱えています。
その悩みと考えている解決策を公開することによって、意見交換したり、何かの参考になればいいなと思います。</p>

<h1>Jenkins、ビルドの設定</h1>

<p>弊社のAndroidのJenkinsはawsで<a href="http://mrkn.hatenablog.com/entry/2013/07/26/172040">ここ</a>の1スレーブとして動いています。</p>

<p>ビルドにはgradleを使っていて、以下の設定で種類ごとにbuildを行なっています。</p>

<pre><code class="groovy">buildTypes {
    debug {
        debuggable true
        runProguard false
        ...
    }
    beta {
        debuggable true
        runProguard true
        ...
    }
    release {
        debuggable false
        runProguard true
        ...
    }
}

productFlavors {
    staging {}
    product {}
}
</code></pre>

<p>また、gradleはdaemon起動しています。
ライブラリはs3に認証付きでホストしています。署名の情報もそうですが、キーとシークレットはリポジトリに含められないので、Google Driveに置いて開発者に権限を付与してスクリプトで取得するようにしています。</p>

<pre><code class="groovy">repositories {
    mavenCentral()
    maven {
        url &quot;https://${project.s3Bucket}.s3.amazonaws.com/release&quot;
        credentials {
            username project.s3Key
            password project.s3Secret
        }
    }
}
</code></pre>

<p>実際のジョブの内容は</p>

<ol>
<li>StagingBetaをassembleする</li>
<li>StagingBetaをconnectedInstrumentTestする</li>
<li>Lintを走らせる</li>
<li>ProductBetaをassembleする</li>
<li>DeployGateでProductBetaを配信する</li>
<li>HipChatにビルド結果を通知する</li>
</ol>

<p>というようになっています。</p>

<h1>悩み1. Android Emulatorが不安定</h1>

<p>プロセスが突然クラッシュして、続くビルドでemulatorがタイムアウトしてしまうことがあります。</p>

<pre><code>Tests on Full Android on x86 Emulator - 2.3.7 failed: Instrumentation run failed due to &#39;Process crashed.&#39;
</code></pre>

<pre><code>[android] Timed-out after waiting 180 seconds for emulator
Finished: NOT_BUILT
</code></pre>

<p>テストが悪くて起こることもあるのですが、確率的になることもあり原因がよく分かっていません。
また、こちらも原因不明なのですが <code>adb -s localhost:47245 shell input keyevent 82</code> のメッセージを出したまま永遠に返ってこなくなることもあります。
この前は8時間固まっていてジョブが詰まっていました（その後Build-timeout Pluginでタイムアウト設定をするようにしました）。</p>

<h1>悩み2. ビルドに時間がかかる</h1>

<p>確か最初の頃は一回3分とかで終わっていたと思うのですが、プロジェクトが進んでテストもだんだん増えていって6分くらいになりました。
Jenkinsではandroid-18（4.3）で、手元ではGenymotionの4.3で動作確認をしていたのですが、ある日Android 2系でアプリを起動するとcompatのコードがinjection周りでクラッシュすることに気付きました。
開発するときに手元で2系と4系の両方で確認するのは大変なので、Jenkinsでマトリックスビルドするようにしました。</p>

<p><img src="https://dl.dropboxusercontent.com/u/54255753/blog/201311/build_matrix.png" alt=""></p>

<p>android-10 &amp;&amp; armeabi + android-18 &amp;&amp; armeabi-v7a という構成です。
ところがこの構成にした途端に、ビルド時間が40分を超えるようになりました。</p>

<p><blockquote class="twitter-tweet" lang="en"><a href="{% oembed https://twitter.com/rejasupotaro/status/397977669062500352 %}"></a></blockquote><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></p>

<p>そこで構成を android-10 &amp;&amp; x86 + android-18 &amp;&amp; x86 に変更しました。</p>

<p><img src="https://dl.dropboxusercontent.com/u/54255753/blog/201312/matrix.png" alt=""></p>

<p>それで今36分くらいです。
どちらにせよ長すぎるのでなんとかしたいです。</p>

<h1>ビルドを安定させる案</h1>

<p>Android Emulator Plugin以外のもの使う場合を考えます。</p>

<h2>Robolectricを使う</h2>

<p>実行環境がDalvikじゃないので信頼できるのかというところですが、楽天では4ヶ月使ってみてRobolectric由来の問題にあたったことがないとのことです。
この手の問題ですが、たとえばDexFileを弄るとか、Androidの環境に依存するようなコードは、ActiveAndroidのようにRobolectricのためのフォールバックの処理を入れる必要があります。</p>

<pre><code class="java">if (sourcePath != null &amp;&amp; !(new File(sourcePath).isDirectory())) {
    DexFile dexfile = new DexFile(sourcePath);
    Enumeration&lt;String&gt; entries = dexfile.entries();

    while (entries.hasMoreElements()) {
        paths.add(entries.nextElement());
    }
}
// Robolectric fallback
else {
    ClassLoader classLoader = Thread.currentThread().getContextClassLoader();
    Enumeration&lt;URL&gt; resources = classLoader.getResources(&quot;&quot;);

    while (resources.hasMoreElements()) {
        String path = resources.nextElement().getFile();
        if (path.contains(&quot;bin&quot;) || path.contains(&quot;classes&quot;)) {
            paths.add(path);
        }
    }
}
</code></pre>

<p>すべてのライブラリがRobolectric対応しているとも限りませんし、うまく動かなかったら自分で直そうという雰囲気を感じます。</p>

<p>UIのテストをすることになったら実機かEmulatorが必要になるので、Robolectricを使うというのはビルドの安定化というより高速化の方かもしれないと思いました。</p>

<h2>Genymotionを使う</h2>

<p>Genymotionの開発元が<a href="http://blog.genymobile.com/genymotion-jenkins-android-testing/">今のところヘッドレスでは動かない</a>と言ってます。</p>

<p>ところで弊社のiOS開発はどうしているかというと、社内のmac miniでXcode 5からの新機能のBotsを使ってCIしています。
なので、Genymotionを使うならawsからmac miniに移す感じになるかなと思います。</p>

<h2>実機を使う</h2>

<p>Genymotionを使うのとほぼ一緒です。
mac miniに直接実機を繋ぎます。</p>

<p><img src="http://square.github.io/spoon/static/device_cluster.png" width="360px"></p>

<p>ついでに会社の使ってない検証機を繋いでおいて常時テストが走るみたいにしておくと便利かもしれません。</p>

<h1>ジョブの実行時間の短縮させる案</h1>

<h2>ジョブを分割する</h2>

<p>2つのジョブを続けて実行するのに比べるとマトリックスビルドは明らかにオーバーヘッドが大きい（6分 * 2で12分のはずが35分かかってる）ので、マトリックスビルドをやめて環境ごとにジョブを増やします。
ジョブを二重で管理しないといけなくなるという問題が発生しますが、スクリプトはgitで取ってきたり、ジョブ間の設定の差分を見れるようにするなどすればいいかなと思います。</p>

<h2>ビルドを速くする</h2>

<p><a href="http://www.infoq.com/jp/news/2013/05/Facebook-buck-xctool-build">FacebookのBuckとxctool</a> によると、Buckはmavenの10倍ビルドが速いらしいので、たとえばBuckに移行するとか（今のところ考えていませんが）、あるいはGradleがもっと速くなるように<a href="https://github.com/gradle/gradle/pulls">コミットする</a>とかです。</p>

<p>ただし、全体の実行時間のうちビルド時間が占める割合は小さいので、エミュレータの起動と接続、あるいはテストの高速化にリソースを割いた方が大きな成果が得られると思います。</p>

<h2>テストを速くする</h2>

<p>性能の高いインスタンスに乗り換える、Robolectricを使う、Genymotionを使うなどの方法があります。
そういえばEspressoってUIテストを並列化しているそうですね：<a href="http://www.infoq.com/jp/news/2013/11/google-espresso-testing">Google Espresso: Android UI のクラウド型高速自動化テスト</a>
ビジネスロジックはRobolectricでUIはEspressoで、みたいになるのでしょうか。</p>

<h1>まとめ</h1>

<p>弊社のCIの悩みと今考えている解決策を書きました。
安定化に関しても高速化に関してもGenymotionを入れるとひとまず解決する気がするので、awsにいたJenkinsをmac miniに移そうかと思います。</p>

</article>
<p>
  <a class="twitter-share-button">"https://twitter.com/share" "Tweet"</a> 
  <script type="text/javascript">
    !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');
  </script>
</p>
      </div>
    </div>
    <footer class="footer">
      <div class="footer-inner">
        <p class="footer-copyright">
          Copyright &copy; 2013 by <a target="_blank" href="http://twitter.com/rejasupotaro">@rejasupotaro</a>
        </p>
        <p class="footer-powers">
          Powered by <a href="https://github.com/r7kamura/r7kamura.github.io">Github</a> & <a href="https://github.com/r7kamura/sitespec">Sitespec</a>
        </p>
      </div>
    </footer>
  </body>
</html>