<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" />
    <title>Travis便利最高！！！！ - Rejasupoem</title><link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" /><link href="/stylesheets/all.css?1391914058" media="all" rel="stylesheet" type="text/css" /><link href="/images/favicon.ico" rel="icon" type="image/ico" />
  </head>
  <body>
    <link href="http://yandex.st/highlightjs/8.0/styles/monokai_sublime.min.css" rel="stylesheet" type="text/css" />
    <script src="http://yandex.st/highlightjs/8.0/highlight.min.js"></script>
    <script type="text/javascript">
      hljs.initHighlightingOnLoad();
    </script>
    <header class="header">
      <div class="header-inner"><a href="/">
        <div class="header-image">
          <img width="100" height="100" class="header-image-element" src="/images/rejasupotaro.jpg?1391914058" />
        </div>
        <div class="header-text">
          <h1 class="header-text-title">
            Rejasupoem
          </h1>
          <p class="header-text-description">
            continue to deliver value to customers or die;
          </p>
        </div></a>
        
      </div>
    </header>
    <hr />
    <div class="main">
      <div class="main-inner main-inner-single-article"><article class="main-article">
  <div class="main-article-header">
    <h1 class="main-article-header-title">
      Travis便利最高！！！！
    </h1>
    <div class="main-article-header-date">
      2013-11-25
    </div>
  </div><h2>背景</h2>

<p><a href="http://www.activeandroid.com/">ActiveAndroid</a> にissueがたまっていたのでみようかなと思って、とりあえずmasterでテストを実行してみる。</p>

<pre><code>$ mvn clean install
[INFO] ------------------------------------------------------------------------
[INFO] Reactor Summary:
[INFO] 
[INFO] ActiveAndroid - Parent ............................ SUCCESS [0.121s]
[INFO] ActiveAndroid ..................................... SUCCESS [1.696s]
[INFO] ActiveAndroid - Tests ............................. FAILURE [7.837s]
[INFO] ------------------------------------------------------------------------
[INFO] BUILD FAILURE
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 10.669s
[INFO] Finished at: Sun Nov 24 23:18:31 JST 2013
[INFO] Final Memory: 28M/242M
[INFO] ------------------------------------------------------------------------
</code></pre>

<p>............................. FAILURE (´･_･`)</p>

<h3>テストがコケたところを探す</h3>

<pre><code class="sh">$ git bisect start HEAD adcff703
$ git bisect run sh -c &#39;mvn clean install&#39;

commit eeff4063ee7aebf0381ffe4e494c522f5c83b9e2
Author: Michael Pardo &lt;kensuke155@gmail.com&gt;
Date:   Fri Aug 30 15:37:37 2013 -0400

    Use configuration.
</code></pre>

<p>(´･_･`)</p>

<h3>なぜコケてるか調べる</h3>

<pre><code class="java">private void scanForModel(Context context) throws IOException {
    String packageName = context.getPackageName();
    String sourcePath = context.getApplicationInfo().sourceDir;
    List&lt;String&gt; paths = new ArrayList&lt;String&gt;();

    if (sourcePath != null &amp;&amp; !(new File(sourcePath).isDirectory())) {
        DexFile dexfile = new DexFile(sourcePath);
        Enumeration&lt;String&gt; entries = dexfile.entries();

        while (entries.hasMoreElements()) {
            paths.add(entries.nextElement());
        }
    }
    // Robolectric fallback
    else {
        ClassLoader classLoader = Thread.currentThread().getContextClassLoader();
        Enumeration&lt;URL&gt; resources = classLoader.getResources(&quot;&quot;);

        while (resources.hasMoreElements()) {
            String path = resources.nextElement().getFile();
            if (path.contains(&quot;bin&quot;) || path.contains(&quot;classes&quot;)) {
                paths.add(path);
            }
        }
    }

    for (String path : paths) {
        File file = new File(path);
-        scanForModelClasses(file, packageName, context.getClass().getClassLoader());
+        scanForModelClasses(file, packageName, context.getClassLoader());
    }
}
</code></pre>

<p><code>Class#getClassLoader</code> と <code>ContextWrapper#getClassLoader</code> では動作違う。
<code>Class#getClassLoader</code> ではアプリからは動的ローディングができるけど、テストアプリはModelをロードできない(´･_･`)</p>

<h3>テストがいつコケたか分からないような状況は良くない</h3>

<p><img src="https://dl.dropboxusercontent.com/u/54255753/blog/201312/activeandroid.png" width="640px"></p>

<p>ActiveAndroid、Travis回してるじゃないか。</p>

<pre><code class="yaml">language: java
jdk: oraclejdk7

before_install:
  # Gradle
  - wget http://services.gradle.org/distributions/gradle-1.6-bin.zip
  - unzip gradle-1.6-bin.zip
  - export GRADLE_HOME=$PWD/gradle-1.6
  - export PATH=$GRADLE_HOME/bin:$PATH

script: gradle assemble
</code></pre>

<p>テストを実行してない(´･_･`)
Travisでテストを実行するようにすれば、テストがコケる差分は入らない。
以下のように変更。</p>

<pre><code class="yaml">language: java
jdk: oraclejdk7
env: ANDROID_SDK=android-16 ANDROID_ABI=armeabi-v7a

before_install:
  # Install ia32-libs (necessary for Android SDK to run on 64-bit linux)
  # - sudo apt-get clean &amp;&amp; sudo apt-get update
  - sudo apt-get update -qq
  - sudo apt-get install -qq --force-yes libgd2-xpm ia32-libs ia32-libs-multiarch

  # Install Android SDK
  - wget http://dl.google.com/android/android-sdk_r21.0.1-linux.tgz
  - tar -zxf android-sdk_r21.0.1-linux.tgz
  - ls
  - export ANDROID_HOME=`pwd`/android-sdk-linux
  - export PATH=${PATH}:${ANDROID_HOME}/tools:${ANDROID_HOME}/platform-tools

  # Install required Android components
  - android list sdk --extended
  # Do you accept the license &#39;android-sdk-license-bcbbd656&#39; [y/n]:
  - echo -ne &quot;y\n&quot; | android update sdk --filter system-image,platform-tools,extra-android-support,$ANDROID_SDK --no-ui --force

  # Create and start emulator
  - echo no | android create avd --force -n test -t $ANDROID_SDK --abi $ANDROID_ABI
  - android list avds
  - emulator -avd test -no-skin -no-audio -no-window &amp;

before_script:
  # Make sure the emulator has started before running tests
  - chmod +x ./wait_for_emulator
  - ./wait_for_emulator

script:
  - wget http://ftp.tsukuba.wide.ad.jp/software/apache/maven/maven-3/3.0.5/binaries/apache-maven-3.0.5-bin.tar.gz
  - tar -zxf apache-maven-3.0.5-bin.tar.gz
  - sudo rm /usr/local/maven
  - sudo rm -rf /usr/local/maven-3.1.1
  # Dirty hack
  - sudo mv ./apache-maven-3.0.5 /usr/local/maven-3.1.1
  - sudo ln -sf /usr/local/maven-3.1.1 /usr/local/maven
  - which mvn
  - mvn --version
  - mvn clean install
</code></pre>

<p><strong>!!!Dirty hack!!!</strong></p>

<p>Travisでmavenを走らせるのにハマる。</p>

<p><img src="https://dl.dropboxusercontent.com/u/54255753/blog/201312/travis_log.png" width="120px"></p>

<ul>
<li>Javaがビルド時にNoClassDefFoundError、設定を変えながらビルドするもだめ（ビルド1〜20）</li>
<li>mavenが最新バージョン（3.1.1）だとmaven-android-pluginがコケることに気付く（ビルド21〜30）</li>
<li>mavenのバージョンを3.0.5に下げるために奮闘する（ビルド31〜54）</li>
</ul>

<h3>Travisの罠</h3>

<ul>
<li>3.0.5をwgetして直接実行しても3.1.1が使われる…（なお$M2_HOMEも$M2も定義されていないことは確認済み）</li>
</ul>

<pre><code class="sh">$ /path/to/maven-3.0.5/bin/mvn --version
Picked up _JAVA_OPTIONS: -Dfile.encoding=UTF-8
Apache Maven 3.1.1
...
</code></pre>

<p>(´･_･`)</p>

<ul>
<li>bin/mvn のソースを読んでたら /etc/mavenrc と ~/mavenrc のパスをみてることが判明</li>
<li>環境変数（mavenrc、$M2_HOME、$M2）を上書きするもどうしても最新版が使われる…</li>
<li>Travisにインストールされている3.1.1を削除して3.0.5にsymlinkを貼る</li>
<li>実行時に3.1.1を実行しようとしててそんなバージョンないと言われる…</li>
<li><code>/home/travis/build.sh</code> が3.1.1を実行しようとしていることが判明</li>
<li><strong>!!!Dirty hack発動!!!</strong></li>
</ul>

<p><img src="https://dl.dropboxusercontent.com/u/54255753/blog/201312/d4c1.jpg" width="360px"></p>

<h2><a href="https://github.com/pardom/ActiveAndroid/pull/146">プルリ完成</a></h2>

<p><img src="https://dl.dropboxusercontent.com/u/54255753/blog/201312/d4c2.png" width="360px"></p>

<h2>Travis最高！！！！</h2>

<p>もうちょっと調べれば原因が分かりそうだけど、Travisにはshellで入れないため一回一回情報を出力するのに心が折れたけど、テスト環境なので動けばよかろうなのだ。</p>

</article>
<a class="twitter-share-button">"https://twitter.com/share" "Tweet"</a> 
<script type="text/javascript">
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');
</script>
      </div>
    </div>
    <footer class="footer">
      <div class="footer-inner">
        <p class="footer-copyright">
          Copyright &copy; 2013 by <a target="_blank" href="http://twitter.com/rejasupotaro">@rejasupotaro</a>
        </p>
        <p class="footer-powers">
          Powered by <a href="https://github.com/r7kamura/r7kamura.github.io">Github</a> & <a href="https://github.com/r7kamura/sitespec">Sitespec</a>
        </p>
      </div>
    </footer>
  </body>
</html>