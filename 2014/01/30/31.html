<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" />
    <title>進捗、例外、画面の切り替え - Rejasupoem</title><link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" /><link href="/stylesheets/all.css?1391914059" media="all" rel="stylesheet" type="text/css" /><link href="/images/favicon.ico" rel="icon" type="image/ico" />
  </head>
  <body>
    <link href="http://yandex.st/highlightjs/8.0/styles/monokai_sublime.min.css" rel="stylesheet" type="text/css" />
    <script src="http://yandex.st/highlightjs/8.0/highlight.min.js"></script>
    <script type="text/javascript">
      hljs.initHighlightingOnLoad();
    </script>
    <header class="header">
      <div class="header-inner"><a href="/">
        <div class="header-image">
          <img width="100" height="100" class="header-image-element" src="/images/rejasupotaro.jpg?1391914059" />
        </div>
        <div class="header-text">
          <h1 class="header-text-title">
            Rejasupoem
          </h1>
          <p class="header-text-description">
            continue to deliver value to customers or die;
          </p>
        </div></a>
        
      </div>
    </header>
    <hr />
    <div class="main">
      <div class="main-inner main-inner-single-article"><article class="main-article">
  <div class="main-article-header">
    <h1 class="main-article-header-title">
      進捗、例外、画面の切り替え
    </h1>
    <div class="main-article-header-date">
      2014-01-30
    </div>
  </div><p><img src="https://dl.dropboxusercontent.com/u/54255753/blog/201401/state.png" width="600"></p>

<p>ネットワークからデータを取ってくるときにProgressBarを回して、正常に読み込みたらコンテンツを、読み込めなかったらエラーを表示したいときどうしますか？</p>

<h1>愚直な方法</h1>

<p>全体をFrameLayoutにしてコンテンツの上にProgressView、ErrorViewになるように重ねる。</p>

<pre><code class="xml">&lt;FrameLayout
        android:background=&quot;@android:color/holo_blue_light&quot;
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;match_parent&quot;
        &gt;
    &lt;LinearLayout
            android:orientation=&quot;vertical&quot;
            android:layout_gravity=&quot;center&quot;
            android:layout_width=&quot;wrap_content&quot;
            android:layout_height=&quot;wrap_content&quot;
            &gt;
        &lt;ImageView
                android:src=&quot;@drawable/droid&quot;
                android:layout_gravity=&quot;center&quot;
                android:layout_width=&quot;wrap_content&quot;
                android:layout_height=&quot;wrap_content&quot;
                /&gt;
        &lt;TextView
                android:text=&quot;content&quot;
                android:textSize=&quot;@dimen/default_text_size&quot;
                android:textColor=&quot;@color/default_text_color&quot;
                android:layout_gravity=&quot;center&quot;
                android:layout_width=&quot;wrap_content&quot;
                android:layout_height=&quot;wrap_content&quot;
                /&gt;
    &lt;/LinearLayout&gt;
    <!-- 以下を元のレイアウトに追加 -->
    &lt;include
        android:id=&quot;@+id/progress_view&quot;
        layout=&quot;@layout/progress_view&quot;
        android:visibility=&quot;gone&quot;
        /&gt;
    &lt;include
        android:id=&quot;@+id/error_view&quot;
        layout=&quot;@layout/error_view&quot;
        android:visibility=&quot;gone&quot;
        /&gt;
&lt;/FrameLayout&gt;
</code></pre>

<p>続いてジャバ。</p>

<pre><code class="java">@InjectView(R.id.progress_view) private View mProgressView;
@InjectView(R.id.error_view) private View mErrorView;

private void requestRssFeed() {
    mProgressView.show();
    mErrorView.hide();

    mRssFeedClient.request(new RssFeedClient.EpisodeClientResponseHandler() {
        @Override public void onSuccess(List&lt;Episode&gt; episodeList) {
            BusProvider.getInstance().post(new LoadEpisodeListCompleteEvent(episodeList));
            mProgressView.hide();
            mErrorView.hide();
        }

        @Override public void onFailure() {
            ToastUtils.show(getActivity(), &quot;An error occurred while requesting rss feed.&quot;);
            mProgressView.hide();
            mErrorView.show();
        }
    });
}
</code></pre>

<p>悪くはないけど、</p>

<ul>
<li>元のレイアウトをあまり変更したくない</li>
<li>ProgressViewとErrorViewを別々に扱うので不安になる</li>
</ul>

<p>って書きながら思った。</p>

<h1>もうちょっとスマートに表現</h1>

<p>全体を囲むViewGroupがステートを持ってた方がいいかなと思って以下のように実装。</p>

<pre><code class="xml"><!-- FrameLayoutの代わりにStateFrameLayout(作った)を使う -->
&lt;rejasupotaro.sample.views.StateFrameLayout
        android:id=&quot;@+id/state_frame_layout&quot;
        android:background=&quot;@android:color/holo_blue_light&quot;
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;match_parent&quot;
        &gt;
    &lt;LinearLayout
            android:orientation=&quot;vertical&quot;
            android:layout_gravity=&quot;center&quot;
            android:layout_width=&quot;wrap_content&quot;
            android:layout_height=&quot;wrap_content&quot;
            &gt;
        &lt;ImageView
                android:src=&quot;@drawable/droid&quot;
                android:layout_gravity=&quot;center&quot;
                android:layout_width=&quot;wrap_content&quot;
                android:layout_height=&quot;wrap_content&quot;
                /&gt;
        &lt;TextView
                android:text=&quot;content&quot;
                android:textSize=&quot;@dimen/default_text_size&quot;
                android:textColor=&quot;@color/default_text_color&quot;
                android:layout_gravity=&quot;center&quot;
                android:layout_width=&quot;wrap_content&quot;
                android:layout_height=&quot;wrap_content&quot;
                /&gt;
    &lt;/LinearLayout&gt;
&lt;/rejasupotaro.sample.views.StateFrameLayout&gt;
</code></pre>

<p>続いてジャバ。</p>

<pre><code class="java">@InjectView(R.id.state_frame_layout) private StateFrameLayout mStateFrameLayout;

private void requestRssFeed() {
    mStateFrameLayout.showProgress();

    mRssFeedClient.request(new RssFeedClient.EpisodeClientResponseHandler() {
        @Override public void onSuccess(List&lt;Episode&gt; episodeList) {
            BusProvider.getInstance().post(new LoadEpisodeListCompleteEvent(episodeList));
            mStateFrameLayout.showContent();
        }

        @Override public void onFailure() {
            ToastUtils.show(getActivity(), &quot;An error occurred while requesting rss feed.&quot;);
            mStateFrameLayout.showError();
        }
    });
}
</code></pre>

<ul>
<li>元のレイアウトに変更はほぼ必要ない</li>
<li>ステートの管理が少し楽になる</li>
</ul>

<h3>確認してみる</h3>

<p>とりあえず2秒ごとにステートを変更してみる。</p>

<pre><code class="java">handler.postDelayed(new Runnable() {
        @Override public void run() {
            if (mStateFrameLayout.isStateProgress()) {
                mStateFrameLayout.showError();
            } else if (mStateFrameLayout.isStateError()) {
                mStateFrameLayout.showContent();
            } else {
                mStateFrameLayout.showProgress();
            }
            handler.postDelayed(this, TASK_INTERVAL_MILLIS);
        }
}, TASK_INTERVAL_MILLIS);
</code></pre>

<p><img src="http://gifzo.net/BMfi6eoXjgf.gif" width="200"></p>

<p>ちゃんと動いてるっぽい。</p>

<h1>StateFrameLayout</h1>

<p>ContentViewがinflateされたタイミングでProgressViewとErrorViewを生成してセットし直してるだけです(なので動的にビューを追加しようとしたらちょっと変更が必要です)。</p>

<pre><code>public class StateFrameLayout extends FrameLayout {

    private View mContentView;
    private View mProgressView;
    private View mErrorView;
    private State mState = State.CONTENT;

    public static enum State {
        CONTENT,
        PROGRESS,
        ERORR;
    }

    public State getState() {
        return mState;
    }

    public boolean isStateContent() {
        return (mState == State.CONTENT);
    }

    public boolean isStateProgress() {
        return (mState == State.PROGRESS);
    }

    public boolean isStateError() {
        return (mState == State.ERORR);
    }

    public StateFrameLayout(Context context, AttributeSet attrs) {
        super(context, attrs);
    }

    @Override public void onFinishInflate() {
        setupView();
    }

    private void setupView() {
        List&lt;View&gt; children = getAllChildren();
        removeAllViews();

        mContentView = inflateContentView(children);
        mProgressView = View.inflate(getContext(), R.layout.progress_view, null);
        mErrorView = View.inflate(getContext(), R.layout.error_view, null);

        addView(mContentView);
        addView(mProgressView);
        addView(mErrorView);
    }

    private List&lt;View&gt; getAllChildren() {
        List&lt;View&gt; children = new ArrayList&lt;&gt;();
        int childCount = getChildCount();
        for (int i = 0; i &lt; childCount; i++) {
            children.add(getChildAt(i));
        }

        return children;
    }

    private View inflateContentView(List&lt;View&gt; viewList) {
        FrameLayout frameLayout = new FrameLayout(getContext());
        for (View view : viewList) {
            frameLayout.addView(view);
        }
        return frameLayout;
    }

    public void showProgress() {
        mContentView.setVisibility(View.GONE);
        mProgressView.setVisibility(View.VISIBLE);
        mErrorView.setVisibility(View.GONE);

        mState = State.PROGRESS;
    }

    public void showError() {
        mContentView.setVisibility(View.GONE);
        mProgressView.setVisibility(View.GONE);
        mErrorView.setVisibility(View.VISIBLE);

        mState = State.ERORR;
    }

    public void showContent() {
        mContentView.setVisibility(View.VISIBLE);
        mProgressView.setVisibility(View.GONE);
        mErrorView.setVisibility(View.GONE);

        mState = State.CONTENT;
    }
}
</code></pre>

<p>ProgressViewとかErrorViewのレイアウトIDとか、エラー文言とかはXMLに書けると再利用性高まると思う。
属性は <code>namespace + attribute</code> で取れる。たとえば <code>android:text</code> ならこんな感じで。</p>

<pre><code>// LayoutUtils.java とかにどうぞ
private static final String NAME_SPACE_ANDROID = &quot;http://schemas.android.com/apk/res/android&quot;;

public static final String getStringFromAttribute(Context context, AttributeSet attrs) {
    if (context == null || attrs == null) return &quot;&quot;;

    int textId = attrs.getAttributeResourceValue(NAME_SPACE_ANDROID, &quot;text&quot;, -1);
    if (textId == -1) {
        context.getString(textId)
    } else {
        return &quot;&quot;;
    }
}
</code></pre>

<p>あとビューのデバッグするのにJakeWharton神の<a href="https://github.com/JakeWharton/scalpel">Scalpel</a>便利。</p>

<p><img src="https://dl.dropboxusercontent.com/u/54255753/blog/201401/scalpel.png" width="200"></p>

<p><img src="https://github.com/JakeWharton/scalpel/raw/master/images/sample.gif" width="200"></p>

</article>
<a class="twitter-share-button">"https://twitter.com/share" "Tweet"</a> 
<script type="text/javascript">
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');
</script>
      </div>
    </div>
    <footer class="footer">
      <div class="footer-inner">
        <p class="footer-copyright">
          Copyright &copy; 2013 by <a target="_blank" href="http://twitter.com/rejasupotaro">@rejasupotaro</a>
        </p>
        <p class="footer-powers">
          Powered by <a href="https://github.com/r7kamura/r7kamura.github.io">Github</a> & <a href="https://github.com/r7kamura/sitespec">Sitespec</a>
        </p>
      </div>
    </footer>
  </body>
</html>