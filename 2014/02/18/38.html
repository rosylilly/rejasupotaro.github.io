<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" />
    <title>Rebuild.fmクライアント(非公式)開発の裏話 - Rejasupoem</title><link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" /><link href="/stylesheets/all.css?1393717269" media="all" rel="stylesheet" type="text/css" /><link href="/images/favicon.ico" rel="icon" type="image/ico" />
  </head>
  <body>
    <link href="http://yandex.st/highlightjs/8.0/styles/solarized_light.min.css" rel="stylesheet" type="text/css" />
    <script src="http://yandex.st/highlightjs/8.0/highlight.min.js"></script>
    <script type="text/javascript">
      hljs.initHighlightingOnLoad();
    </script>
    <header class="header">
      <div class="header-inner"><a href="/">
        <div class="header-image">
          <img width="100" height="100" class="header-image-element" src="/images/rejasupotaro.jpg?1393717269" />
        </div>
        <div class="header-text">
          <h1 class="header-text-title">
            Rejasupoem
          </h1>
          <p class="header-text-description">
            deliver value to customers continuously or die;
          </p>
        </div></a>
        
      </div>
    </header>
    <hr />
    <div class="main">
      <div class="main-inner main-inner-single-article"><article class="main-article">
  <div class="main-article-header">
    <h1 class="main-article-header-title">
      Rebuild.fmクライアント(非公式)開発の裏話
    </h1>
    <div class="main-article-header-date">
      2014-02-18
    </div>
  </div><p><img src="https://raw2.github.com/rejasupotaro/Rebuild/master/screenshot.png" alt=""></p>

<p><a href="http://rejasupotaro.github.io/2014/02/17/37.html">Rebuild.fmクライアント(非公式)をリリースしました</a>の開発の中で生まれたtipsや思い出を紹介しようと思います。
結構長いです。</p>

<h1>目次</h1>

<ul>
<li>アプリのバージョニング</li>
<li>RSSフィードの取得</li>
<li>メディアの再生/停止ボタン</li>
<li>Show Notesの表示</li>
<li>MenuDeledate</li>
<li>データの保存とテスト</li>
<li>Tweetの取得</li>
<li>FontAwesome</li>
<li>通知の管理</li>
<li>ライセンス表示</li>
<li>進捗と開発のボトルネック</li>
</ul>

<h1>バージョニング</h1>

<p>Android端末の設定からアプリ情報を見ると &quot;バージョン0.1.2-SHA1&quot; の形式になっていると思います。
Androidアプリのバージョンコードは整数でなければなりませんが、バージョン名は文字列なので、開発者が好きなように使うことができます。
たとえばビルドした日付を入れている開発者もいますし、独自に定義したコードを使っている人もいます。
僕の場合はオープンソースでやってるし、日付よりGitのログの方が有用かなと思って、このようにしました。</p>

<p>というか思い立って調べたら<a href="https://plus.google.com/+JakeWharton/posts/6f5TcVPRZij">Jake Wharton神の記事</a>が出てきたので、ほぼそのとおりに設定しました。
以下、アプリのビルド設定の一部です。</p>

<pre><code>def versionMajor = 0
def versionMinor = 1
def versionPatch = 2
def versionBuild = 0 // bump for dogfood builds, public betas, etc.

def gitSha() {
    return &#39;git rev-parse --short HEAD&#39;.execute().text.trim()
}

android {
    compileSdkVersion 18
    buildToolsVersion &quot;19.0.1&quot;

    defaultConfig {
        minSdkVersion 14
        targetSdkVersion 18
        versionCode versionMajor * 10000 + versionMinor * 1000 + versionPatch * 100 + versionBuild
        versionName &quot;${versionMajor}.${versionMinor}.${versionPatch}-${gitSha()}&quot;
    }

    ...
</code></pre>

<p>こんな感じで、バージョンコードとバージョンネームの生成はコードに任せています。</p>

<h1>RSSフィードの取得</h1>

<p>エピソードの取得ですが、アプリの起動時に<a href="http://feeds.rebuild.fm/rebuildfm">Rebuild.fmのRSS</a>を取得しています。
Androidで使えるRSSクライアントが見当たらなかったので、SAXParserを使って頑張ってparseしています。</p>

<p>一応ライブラリにしました：<a href="https://github.com/rejasupotaro/AsyncRssClient">rejasupotaro / AsyncRssClient</a></p>

<p>今思うとjsonicとgsonを使って、</p>

<ul>
<li>before</li>
</ul>

<pre><code>url -> [ xml -> entity ] -> entity
</code></pre>

<ul>
<li>after</li>
</ul>

<pre><code>url, meta -> [ xml -> json -> entity ] -> entity
</code></pre>

<p>こうした方が良かったなと思いました。</p>

<h1>メディアの再生/停止ボタン</h1>

<p>最近<a href="http://rejasupotaro.github.io/2014/02/09/35.html">別のアプリ</a>でも再生/停止ボタンを作ったのですが、</p>

<p><img src="https://github.com/rejasupotaro/KinMozaViewer/blob/master/screenshot.png?raw=true" alt=""></p>

<p>2つのステートを持つImageViewは、CheckBoxを使うと簡単に実装できます。</p>

<h3>media_start_and_pause_button.xml</h3>

<p>まず、drawableにチェックされているときと、チェックされていないときの画像を定義します。</p>

<pre><code>&lt;selector xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt;
    &lt;item
            android:state_checked=&quot;true&quot;
            android:drawable=&quot;@android:drawable/ic_media_pause&quot; /&gt;
    &lt;item
            android:state_checked=&quot;false&quot;
            android:drawable=&quot;@android:drawable/ic_media_play&quot; /&gt;
&lt;/selector&gt;
</code></pre>

<h3>style.xml</h3>

<p>次に、Widget.CompoundButton.CheckBoxを継承したチェックボックスのスタイルを作って、drawableを上書きします。</p>

<pre><code>&lt;style name=&quot;MediaStartAndPauseButton&quot; parent=&quot;android:Widget.CompoundButton.CheckBox&quot;&gt;
    &lt;item name=&quot;android:button&quot;&gt;@drawable/media_start_and_pause_button&lt;/item&gt;
    &lt;item name=&quot;android:layout_width&quot;&gt;wrap_content&lt;/item&gt;
    &lt;item name=&quot;android:layout_height&quot;&gt;wrap_content&lt;/item&gt;
&lt;/style&gt;
</code></pre>

<h3>FragmentのLayout</h3>

<p>チェックボックスに定義したスタイルを適用します。</p>

<pre><code>&lt;CheckBox
        android:id=&quot;@+id/media_play_and_pause_button&quot;
        style=&quot;@style/MediaPlayAndPauseButton&quot;
        android:layout_marginLeft=&quot;@dimen/margin_icon_button&quot;
        android:layout_gravity=&quot;center&quot;
        /&gt;
</code></pre>

<p>こうすることでOn/Off時の画像の切り替えのコードを書かなくてよくなります。また、</p>

<pre><code class="java">mMediaStartAndPauseButton.setOnCheckedChangeListener(
        new CompoundButton.OnCheckedChangeListener() {
            @Override
            public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) {
                if (isChecked) {
                    start(episode);
                } else {
                    pause();
                }
            }
        });
</code></pre>

<p>OnCheckedChangeListenerが使えたり、isCheckedメソッドが使えたりして、かなり具合がいいです。</p>

<h1>Show Notesの表示</h1>

<p>書いてる途中で寝てしまったのでうちに帰ってから書く。</p>

<h1>MenuDeledate</h1>

<p>書いてる途中で寝てしまったのでうちに帰ってから書く。</p>

<h1>ActiveAndroidとRobotGirl</h1>

<p>書いてる途中で寝てしまったのでうちに帰ってから書く。</p>

<h1>TwitterWidgetの表示</h1>

<p><a href="http://rejasupotaro.github.io/2014/02/20/39.html">書いてる途中で寝てしまったのでうちに帰ってから書く。</a></p>

<h1>FontAwesome</h1>

<p>書いてる途中で寝てしまったのでうちに帰ってから書く。</p>

<h1>通知の管理</h1>

<p>書いてる途中で寝てしまったのでうちに帰ってから書く。</p>

<h1>ライセンス画面</h1>

<p>書いてる途中で寝てしまったのでうちに帰ってから書く。</p>

<h1>進捗と開発のボトルネック</h1>

<p><img src="https://dl.dropboxusercontent.com/u/54255753/blog/201402/frequency.png" alt=""></p>

<p>Code Frequencyをご覧のとおり、11月に着手してその一週間後に機能的にはほぼ完成していました。
そのあと忙しくなってあまり時間が取れずに2月のリリースになったのですが、何がそんな大変だったのかというと、UXとかUIを考えるのにすごく時間がかかりました。</p>

<p><img src="https://dl.dropboxusercontent.com/u/54255753/blog/201402/episode_detail_fragment.png" alt=""></p>

<p>XMLを書いては端末にインストールして確認し、場合によってはFragmentにしたりActivityに戻したりしながら進めてるので、すごく時間がかかっています。
チームで開発しているときは、各々が得意分野をやりますが、一人だと全部自分でしないといけないので、自分の弱点がそのまま開発のボトルネックになるということを実感しました。</p>

<ul>
<li>リポジトリはこちら：<a href="https://github.com/rejasupotaro/Rebuild">rejasupotaro / Rebuild</a></li>
</ul>

</article>
<p>
  <a class="twitter-share-button">"https://twitter.com/share" "Tweet"</a> 
  <script type="text/javascript">
    !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');
  </script>
</p>
      </div>
    </div>
    <footer class="footer">
      <div class="footer-inner">
        <p class="footer-copyright">
          Copyright &copy; 2013 by <a target="_blank" href="http://twitter.com/rejasupotaro">@rejasupotaro</a>
        </p>
        <p class="footer-powers">
          Powered by <a href="https://github.com/r7kamura/r7kamura.github.io">Github</a> & <a href="https://github.com/r7kamura/sitespec">Sitespec</a>
        </p>
      </div>
    </footer>
  </body>
</html>