<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" />
    <title>ListViewのデータのbindはこうする2014 - Rejasupoem</title><link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" /><link href="/stylesheets/all.css?1392683238" media="all" rel="stylesheet" type="text/css" /><link href="/images/favicon.ico" rel="icon" type="image/ico" />
  </head>
  <body>
    <link href="http://yandex.st/highlightjs/8.0/styles/solarized_light.min.css" rel="stylesheet" type="text/css" />
    <script src="http://yandex.st/highlightjs/8.0/highlight.min.js"></script>
    <script type="text/javascript">
      hljs.initHighlightingOnLoad();
    </script>
    <header class="header">
      <div class="header-inner"><a href="/">
        <div class="header-image">
          <img width="100" height="100" class="header-image-element" src="/images/rejasupotaro.jpg?1392683238" />
        </div>
        <div class="header-text">
          <h1 class="header-text-title">
            Rejasupoem
          </h1>
          <p class="header-text-description">
            deliver value to customers continuously or die;
          </p>
        </div></a>
        
      </div>
    </header>
    <hr />
    <div class="main">
      <div class="main-inner main-inner-single-article"><article class="main-article">
  <div class="main-article-header">
    <h1 class="main-article-header-title">
      ListViewのデータのbindはこうする2014
    </h1>
    <div class="main-article-header-date">
      2014-02-06
    </div>
  </div><p>基本の割に初心者にとって使うのにハードルが高いview、ListView。
ネット調べると色んなパターンで書かれた例が出てくると思います。</p>

<p>何も知らずにAndroid 1.6とかの時代に書かれたような出どころが不明なサンプルコードをコピペしてうまくいかなくて心が折れるみたいなことを防ぐために、インターネットに出回っているサンプルコードをパターン化して列挙しました。パターン1が一番良くなくて、パターン3あるいはパターン4にするといいと思います。</p>

<p><img src="http://www.geek.com/wp-content/uploads/2009/10/settings.JPG" width="120"></p>

<p>インターネットで調べててAndroid 1.6とか2系の葬式UIが出てきたら、それは昔に書かれたものでそっと閉じたほうがいいです。</p>

<h1>Adapterとは</h1>

<p>AdapterはviewとDataSourceの橋渡しをするものです。</p>

<p><a href="http://www.edureka.in/blog/what-are-adapters-in-android/"><img src="http://www.edureka.in/blog/wp-content/uploads/2013/03/adapters.jpg" alt=""></a></p>

<pre><code class="java">private void setupListView(List&lt;User&gt; userList) {
    UserAdapter adapter = new UserAdapter(context, resourceId, userList);
    // Viewに直接データを渡すのではなく、Adapterを渡す
    mListView.setAdapter(adapter);
}
</code></pre>

<p>そして、viewは生成のコストが高いので、AndroidフレームワークにViewを使い回すしくみがあります。</p>

<p><a href="http://android.amberfog.com/?p=296"><img src="http://android.amberfog.com/wp-content/uploads/2010/02/listview_recycler.jpg" alt=""></a></p>

<h1>1. viewがgetされるたびに生成</h1>

<p>viewが描画位置に入るとgetViewが呼ばれて、viewを生成して返すとそれが描画されます。
recycle poolの存在を知らないと、その都度生成してしまってListViewの描画がガタガタになります(僕も昔やってました)。</p>

<pre><code class="java">public class SampleAdapter1 extends ArrayAdapter&lt;User&gt; {

    public SampleAdapter1(Context context, int resource, List&lt;User&gt; objects) {
        super(context, resource, objects);
    }

    @Override
    public View getView(int position, View convertView, ViewGroup parent) {
        View view = View.inflate(getContext(), R.layout.list_item_user, parent);

        User user = getItem(position);

        TextView numberTextView = (TextView) view.findViewById(R.id.number);
        numberTextView.setText(String.valueOf(position));

        ImageView userThumbnailImageView = (ImageView) view.findViewById(R.id.user_thumbnail);
        new SetBitmapFromNetworkTask(userThumbnailImageView).execute(user.getThumbnailUrl());

        TextView userNameTextView = (TextView) view.findViewById(R.id.user_name);
        userNameTextView.setText(user.getName());

        TextView userBiographyTextView = (TextView) view.findViewById(R.id.user_biography);
        userBiographyTextView.setText(user.getBiography());

        return view;
    }
}
</code></pre>

<h1>2. convertViewがnullのときにだけ生成</h1>

<p>recycle poolからreuseされたviewはconvertViewに入ってくるので、convertViewがnullじゃなければ、中身だけを書き換えて再利用するようにしたコードが以下です。</p>

<pre><code class="java">public class SampleAdapter2 extends ArrayAdapter&lt;User&gt; {

    public SampleAdapter2(Context context, int resource, List&lt;User&gt; objects) {
        super(context, resource, objects);
    }

    @Override
    public View getView(int position, View convertView, ViewGroup parent) {
        if (convertView == null) {
            convertView = View.inflate(getContext(), R.layout.list_item_user, parent);
        }

        User user = getItem(position);

        TextView numberTextView = (TextView) convertView.findViewById(R.id.number);
        numberTextView.setText(String.valueOf(position));

        ImageView userThumbnailImageView = (ImageView) convertView.findViewById(R.id.user_thumbnail);
        new SetBitmapFromNetworkTask(userThumbnailImageView).execute(user.getThumbnailUrl());

        TextView userNameTextView = (TextView) convertView.findViewById(R.id.user_name);
        userNameTextView.setText(user.getName());

        TextView userBiographyTextView = (TextView) convertView.findViewById(R.id.user_biography);
        userBiographyTextView.setText(user.getBiography());

        return convertView;
    }
}
</code></pre>

<h1>3. convertViewがnullのときにだけ生成 + ViewHolderにviewをキャッシュ</h1>

<p>convertViewが使いまわされたリストの一行のviewなのですが、その中のviewを毎回探索するのは無駄なので、ViewHolderクラスを作ってキャッシュさせます。</p>

<pre><code class="java">public class SampleAdapter3 extends ArrayAdapter&lt;User&gt; {

    private static class ViewHolder {
        TextView numberTextView;
        ImageView userThumbnailImageView;
        TextView userNameTextView;
        TextView userBiographyTextView;

        public ViewHolder(View view) {
            this.numberTextView = (TextView) view.findViewById(R.id.number);
            this.userThumbnailImageView = (ImageView) view.findViewById(R.id.user_thumbnail);
            this.userNameTextView = (TextView) view.findViewById(R.id.user_name);
            this.userBiographyTextView = (TextView) view.findViewById(R.id.user_biography);
        }
    }

    public SampleAdapter3(Context context, int resource, List&lt;User&gt; objects) {
        super(context, resource, objects);
    }

    @Override
    public View getView(int position, View convertView, ViewGroup parent) {
        ViewHolder holder;
        if (convertView == null) {
            convertView = View.inflate(getContext(), R.layout.list_item_user, parent);
            holder = new ViewHolder(convertView);
            convertView.setTag(holder);
        } else {
            holder = (ViewHolder) convertView.getTag();
        }

        User user = getItem(position);

        holder.numberTextView.setText(String.valueOf(position));
        new SetBitmapFromNetworkTask(holder.userThumbnailImageView).execute(user.getThumbnailUrl());
        holder.userNameTextView.setText(user.getName());
        holder.userBiographyTextView.setText(user.getBiography());

        return convertView;
    }
}
</code></pre>

<h1>4. BindableAdapterを使う</h1>

<p>「convertViewがnullのときは新しくviewを生成して、nullじゃなかったらViewに値をセットして」をコードに落としこむとこうなる感じです。
IDEのデフォルト機能でViewHolder以外のコードを生成できるので、コンストラクタの引数で迷わないし、型パラメータのおかげでitemをそのままViewにbindできる。</p>

<pre><code class="java">public class SampleAdapter4 extends BindableAdapter&lt;User&gt; {

    public SampleAdapter4(Context context, List&lt;User&gt; episodeList) {
        super(context, episodeList);
    }

    private static class ViewHolder {
        private TextView numberTextView;
        private ImageView userThumbnailImageView;
        private TextView userNameTextView;
        private TextView userBiographyTextView;

        ViewHolder(View view) {
            numberTextView = (TextView) view.findViewById(R.id.number);
            userThumbnailImageView = (ImageView) view.findViewById(R.id.user_thumbnail);
            userNameTextView = (TextView) view.findViewById(R.id.user_name);
            userBiographyTextView = (TextView) view.findViewById(R.id.user_biography);
        }
    }

    @Override
    public View newView(LayoutInflater inflater, int position, ViewGroup container) {
        View view =  inflater.inflate(R.layout.list_item_user, container, false);
        ViewHolder holder = new ViewHolder(view);
        view.setTag(holder);
        return view;
    }

    @Override
    public void bindView(User item, int position, View view) {
        ViewHolder holder = (ViewHolder) view.getTag();

        holder.numberTextView.setText(String.valueOf(position));
        new SetBitmapFromNetworkTask(holder.userThumbnailImageView).execute(item.getThumbnailUrl());
        holder.userNameTextView.setText(item.getName());
        holder.userBiographyTextView.setText(item.getBiography());
    }
}
</code></pre>

<pre><code class="java">public abstract class BindableAdapter&lt;T&gt; extends ArrayAdapter&lt;T&gt; {

    private LayoutInflater mInflater;

    public BindableAdapter(Context context, List&lt;T&gt; episodeList) {
        super(context, 0, episodeList);
        setup(context);
    }

    private void setup(Context context) {
        mInflater = LayoutInflater.from(context);
    }

    @Override
    public final View getView(int position, View view, ViewGroup container) {
        if (view == null) {
            view = newView(mInflater, position, container);
            if (view == null) {
                throw new IllegalStateException(&quot;newView result must not be null.&quot;);
            }
        }
        bindView(getItem(position), position, view);
        return view;
    }

    public abstract View newView(LayoutInflater inflater, int position, ViewGroup container);

    public abstract void bindView(T item, int position, View view);
}
</code></pre>

<p>でもViewHolderを手で書いたり、pluginで生成するのもあれなんですよね、 <strong>まさか来週の<a href="https://github.com/potatotips/potatotips/wiki/potatotips-4">potatotips</a>で@__gfx__さんがgradleでxmlからジャバコードを自動生成するわけじゃあるまいし(前フリ)</strong></p>

</article>
<p>
  <a class="twitter-share-button">"https://twitter.com/share" "Tweet"</a> 
  <script type="text/javascript">
    !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');
  </script>
</p>
      </div>
    </div>
    <footer class="footer">
      <div class="footer-inner">
        <p class="footer-copyright">
          Copyright &copy; 2013 by <a target="_blank" href="http://twitter.com/rejasupotaro">@rejasupotaro</a>
        </p>
        <p class="footer-powers">
          Powered by <a href="https://github.com/r7kamura/r7kamura.github.io">Github</a> & <a href="https://github.com/r7kamura/sitespec">Sitespec</a>
        </p>
      </div>
    </footer>
  </body>
</html>